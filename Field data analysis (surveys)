library(lme4)
library(car)
library(glmmTMB)
library(RVAideMemoire)
library(DHARMa)
library(ggplot2)
library(glmmTMB)
library(Rmisc)

# Set working directory here
#setwd("~/Boulot/Th√®se 2016-2019/AOBox/R/Scripts/Terrain 2018")

####################IMPORTING DATA#######################

  # Field data importation
field_surv <- read.table(file="field_data_surveys.txt",h=T,dec=",")   

  # Calculating parasitism rate field per field and week per week
field_surv$pRate <- field_surv$Tot_mummies/(field_surv$Tot_aphid + field_surv$Tot_mummies)

##################ANALYSES - APHID DENSITY############################

    ### Some data visualization first

field_surv$Position <- as.factor(field_surv$Position)
field_surv$Position <- relevel(field_surv$Position ,'5m')
field_surv$Type <- as.factor(field_surv$Type)
levels(field_surv$Type) <- c('Intercrop','Single crop')

  # Population dynamics

Fig6 <- ggplot(field_surv,aes(x=Week,y=Tot_aphids,colour=Type,fill=Type))+
  facet_wrap(~Position)+
  geom_point(size=1.5)+
  geom_smooth(alpha=0.15)+  ## Fitting a loess smoother to visualize the general dynamics
  xlab("Week")+
  ylab("Aphid abundance")+
  theme(legend.title=element_text(face='bold'),legend.position="bottom")+
  labs(colour='Field type',fill='Field type')

Fig6   #ggsave(Fig6,filename='Figure_6.png',dpi=1000,width=16,height=10,units='cm')

  # Boxplots
ggplot(field_surv,aes(y=Tot_aphids,fill=Type,x=Type))+
  facet_wrap(~Position)+
  geom_boxplot(alpha=0.6,outlier.shape = NA)+
  geom_point(aes(colour=Type),alpha=1,size=1.5,
             position = position_jitterdodge())


   ### Statistical analysis

  # Fitting the model
modAphid <- glmer.nb(Tot_aphids~Type*Position+(1|Week)+(1|Field),data=field_surv)

  # Model summary
summary(modAphid)

  # Residual checks
plotresid(modAphid) # Ok though some values are under-estimated
resAphid <- simulateResiduals(modAphid)
plot(resAphid,asFactor=T) # Second check: OK
testZeroInflation(resAphid) # No zero-inflation
testDispersion(resAphid)  # No overdispersion

  # Testing for effects
Anova(modAphid)

##################ANALYSES - PARASITISM RATES############################

    ### Some data visualization first

  # Getting mean, sd and se values for each field type, position and week
summPara <- summarySE(field_surv, measurevar="pRate", groupvars=c("Type","Position","Week"),na.rm=T)

  # Parasitism dynamics plot
Fig7 <- ggplot(summPara,aes(y=pRate,x=Week,colour=Type))+
  facet_wrap(~Position)+
  geom_errorbar(aes(ymin=pRate-se, ymax=pRate+se), width=.1)+
  geom_line()+
  geom_point(size=1.5)+
  xlab("Week")+
  ylab("Parasitism rate")+
  theme(legend.title=element_text(face='bold'),legend.position="bottom")+
  labs(colour='Field type')

Fig7   #ggsave(Fig7,filename='Figure_7.png',dpi=1000,width=16,height=10,units='cm')

  # Boxplots
ggplot(field_surv,aes(y=pRate,fill=Type,x=Type))+
  facet_wrap(~Position)+
  geom_boxplot(alpha=0.6,outlier.shape = NA)+
  geom_point(aes(colour=Type),alpha=1,size=1.5,
             position = position_jitterdodge())


    ### Statistical analysis

  # Getting the 2-column matrix with number of living aphids and mummies
prMatrix <- as.matrix(field_surv[,c(5,12)])

  # Fitting the model
modPara <- glmer(prMatrix~Type*Position+(1|Week)+(1|Field),data=field_surv,family="binomial")

  # Model summary
summary(modPara)

  # Residual checks
plotresid(modPara) # Ok though some values are under-estimated
resPara <- simulateResiduals(modPara)
plot(resPara,asFactor=T) # Second check: OK
testZeroInflation(resPara) # Seems to be zeo-inflation -> moving to a Zero-inflated model
testDispersion(resPara)  # Could be some overdispersion as well

  # Model2
modParaZI <- glmmTMB(prMatrix~Type*Position+(1|Week)+(1|Field),data=field_surv,family="binomial",ziformula=~1)

summary(modParaZI)  # Highly significant zero-inflated parameter
resParaZI <- simulateResiduals(modParaZI)
plot(resParaZI,asFactor=T) # Second check: OK
testZeroInflation(resParaZI) # Better
testDispersion(resPara)  # Better

  # Testing for effects
Anova(modParaZI)


